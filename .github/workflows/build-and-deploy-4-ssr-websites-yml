name: Build and Deploy (ssr)
on:
  push:
    branches: 
      - master
permissions:
  contents: write
env:
  BUILD_FOLDER: .output/public # or .output/public/yourrepositoryname/
jobs:
  build:
    concurrency: ci-${{ github.ref }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18]
    steps:
    - name: Checkout üõéÔ∏è
      uses: actions/checkout@v3

    - name: Generate static Nuxt 3 files
      uses: actions/setup-node@v3
      with:
        node-version: "16"
        cache: 'npm'
  
    - run: |
        npm ci
        npm run generate
    - name: Init new repo in $BUILD_FOLDER and commit generated files
      run: |
        grep -rnwl "<link rel=\"prefetch\"" $BUILD_FOLDER | xargs sed -i 's$<link rel="prefetch" href="[^"]*\.\(jpg\|png\|webm\|jpeg\|ttg\|svg\|gif\)">$$g'
        cd $BUILD_FOLDER
        touch .nojekyll
        git init
        git add -A
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git commit -m 'deploy'
    - name: Deploy
      uses: JamesIves/github-pages-deploy-action@v4
      with:
        folder: ${{env.BUILD_FOLDER}}